name: Create Version PR from dev -> master

# run when dev branch changes (or keep workflow_dispatch for manual run)
on:
  push:
    branches:
      - dev
  # optional: let you run it manually too
  workflow_dispatch:

permissions:
  contents: write        # required for commits
  pull-requests: write   # required to create PRs

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  create-version-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Set up Git
        run: |
          git config user.name GitHub Actions
          git config user.email actions@github.com
          git config push.autoSetupRemote true 
      
      - name: Modify CHANELOG.md
        run: |
          pnpm run version:changesets
          git switch --create release
          git add .changeset/
          git add CHANGELOG.md
          git add package.json
          git commit -m "Bump NeuroPilot version"
          git push --force
      
      - name: Create a PR
        env:
          BASE_BRANCH: master
          HEAD_BRANCH: release
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh pr list --base "$BASE_BRANCH" --head "$HEAD_BRANCH" --state open --json number --jq '.[0].number' | grep -q '[0-9]'; then
            echo "A PR already exists."
            exit 0
          else
            gh pr create \
              --title "release: new NeuroPilot version" \
              --body "This PR was opened to bump NeuroPilot. If you're not ready yet, leave this PR and continue adding commits to the dev branch. Changes will automatically be force-pushed here." \
              --base "master" \
              --reviewer Pasu4,KTrain5169
          fi
