name: Tests

on:
    push:
        branches-ignore:
            - master
        paths-ignore:
            - ".github/"
            - ".vscode/"
            - ".husky/"
            - "playground/"
            - "tony/"
    pull_request:
        paths-ignore:
            - ".github/"
            - ".vscode/"
            - ".husky/"
            - "playground/"
            - "tony/"
    workflow_dispatch:

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout source repository
              uses: actions/checkout@v4
              with:
                ref: ${{ github.sha }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                version: 10.14.0
            
            - name: Setup Node.js
              uses: actions/setup-node@v4.4.0
              with:
                node-version: 22.x.x
                cache: 'pnpm'
                cache-dependency-path: './pnpm-lock.yaml'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile
            
            - name: Cache VS Code test installation
              uses: actions/cache@v4
              with:
                path: .vscode-test
                key: vscode-test-${{ runner.os }}-${{ hashFiles('package.json', 'pnpm-lock.yaml') }}
                restore-keys: |
                  vscode-test-${{ runner.os }}-
            
            - name: Build project
              run: pnpm build
            
            - name: Run unit tests
              run: pnpm test:unit
            
            - name: Run integration tests
              run: pnpm test:integration
              env:
                # Speed up VS Code test installation
                VSCODE_TEST_VERSION: 1.103.2
            
            - name: Run test coverage
              run: pnpm test:coverage
            
            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              with:
                path: coverage/
                name: coverage-reports-${{ github.sha }}
                retention-days: 30
